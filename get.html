<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TP Integrador 334</title>
    <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.classless.min.css" type="text/css">
    <link rel="stylesheet" href="./css/styles.css">
</head>

<body>
    <header>
        <h1>TP Integrador 334</h1>
        <nav>
            <ul id="listado-nav">
                <li class="links-header"><a href="index.html"><span>GET</span></a></li>
                <li class="links-header"><a href="./get.html"><span>GET: ID</span></a></li>
                <li class="links-header"><a href="./post.html"><span>POST</span></a></li>
                <li class="links-header"><a href="./put.html"><span>PUT</span></a></li>
                <li class="links-header"><a href="./delete.html"><span>DELETE</span></a></li>
            </ul>
        </nav>
    </header>
    <hr>
    <h2>Consultar producto</h2>
    <hr>
    <main id="contenedor-get">
        <div id="productos-container" class="crudFrom-container">
            
            <form id ="getProduct-form">
                <label for="idProd">ID Producto</label>
                <input type="number" name ="idProd" id="idProd" required>
                <input type="submit" value="consultar producto">
            </form>
        </div>
        
        <div id = "getId-container">
            <ul id="getId-list">    
            </ul>
        </div>
        
    </main>

    <script>
        
        let getProductForm = document.getElementById("getProduct-form");
        let getId_lista = document.getElementById("getId-list");

        //Simula una espera de 1 segundo para mostrar el mensaje de "Cargando producto..."
        function esperar(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        getProductForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            
            try{
                getId_lista.innerHTML = "Cargando producto...";
                await esperar(1000); // Espera 1 segundo
                //Creamos un objeto FormData para obtener los datos del formulario de event.target
                let formData = new FormData(event.target);

                //Tansformamos el objeto FormData a un objeto normal que ya posee la id del producto
                let data = Object.fromEntries(formData.entries());
                
                //Obtenemos el id del producto desde el objeto data y le sacamos los espacios en blanco al principio y al final del formulario (En nuestro caso no es necesario, pero es una buena pr√°ctica)
                let idProd = data.idProd.trim();

                //Validacion 1
                if(!idProd){
                    // Si el id del formulario no existe, mandamos un error
                    throw new Error(`Error en el envio de datos del formulario`);
                }

                //Traemos el producto desde la API usando el id del producto
                let respuesta = await fetch(`http://localhost:3000/productos/${idProd}`);

                //Tranformamos el texto a formato JSON
                let datos = await respuesta.json();

                //Validacion 2
                if (!respuesta.ok) {
                    // Si la respuesta no es OK, mandamos un error
                    throw new Error(`Status: ${respuesta.status} StatusText: ${respuesta.statusText}`);
                }

                //Validacion 3
                if(!datos.payload || datos.payload.length === 0) {
                    // Si no hay productos en el payload, mandamos un error
                    throw new Error(`No se encontraron productos con el ID: ${idProd}`);
                }

                //Del JSON obtenido, accedemos al primer elemento del array payload que es el producto que buscamos
                let producto = datos.payload[0];

                let htmlProducto = `
                <li id="producto-encontrado" class="li-listado productos-listados">
                    <img src="${producto.imagen}" alt="${producto.nombre}" class="img-listados">
                    <p>ID: ${producto.id} / Nombre: ${producto.nombre} / <strong>Precio: ${producto.precio} <strong></p>
                </li>`

                getId_lista.innerHTML = htmlProducto;
            }catch (error) {
                console.error(error);
                //Mendaje de error en caso de que algo falle en el html
                getId_lista.innerHTML = `<p class="error">${error.message}</p>`;
            }
        });
    </script>
</body>

</html>